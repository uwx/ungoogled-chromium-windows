name: Build LLVM single step

on:
  workflow_call:
    inputs:
      finished:
        required: true
        type: boolean
      first:
        required: false
        default: false
        type: boolean
      num:
        required: false
        default: -1
        type: number
      mimalloc-artifact-name:
        required: true
        type: string
    outputs:
      finished:
        value: ${{ inputs.finished || jobs.build-llvm.outputs.finished }}

jobs:
  build-llvm:
    name: step ${{ inputs.num }}
    if: '!inputs.finished'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
    env:
      STORE_PATH: 'unset fixme'
      CACHE_PREFIX: ${{ matrix.os }}
      PROJECT_LOCATION: C:\ungoogled-chromium-windows
    steps:
      - name: Download static mimalloc
        uses: actions/download-artifact@v2
        with:
          name: ${{ inputs.mimalloc-artifact-name }}
          path: C:/mimalloc.lib

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Copy ungoogled-chromium stuff to C drive
        run: Copy-Item -Path . -Destination $env:PROJECT_LOCATION -Recurse

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install python dependencies
        run: pip install -r requirements.txt

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ env.CACHE_PREFIX }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ env.CACHE_PREFIX }}-pnpm-store-

      - name: Setup third-party tool cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.PROJECT_LOCATION }}\build\download_cache
            ${{ env.PROJECT_LOCATION }}\build\src\third_party
            !${{ env.PROJECT_LOCATION }}\build\src\third_party\llvm-build
          key: ${{ env.CACHE_PREFIX }}-downloads-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}
          restore-keys: |
            ${{ env.CACHE_PREFIX }}-downloads-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}
            ${{ env.CACHE_PREFIX }}-downloads-partial-including-extracted-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}
            ${{ env.CACHE_PREFIX }}-downloads-partial-download-only-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}

      - name: Setup PGO profile cache
        if: '!steps.cache-check.outputs.cache-hit'
        uses: actions/cache@v3
        with:
          path: |
            **.profdata
            ${{ env.PROJECT_LOCATION }}\**.profdata
          key: ${{ env.CACHE_PREFIX }}-pgo-${{ hashFiles('**.profdata') }}
          restore-keys: |
            ${{ env.CACHE_PREFIX }}-pgo-

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 512M
          key: sccache-llvm-${{ env.CACHE_PREFIX }}
          variant: sccache

      - name: Install node.js dependencies
        id: pnpm-install
        run: pnpm install
        working-directory: ./.github/actions/stage

      - name: Run stage with --no-build flag to download tools and apply patches
        id: prebuild
        uses: ./.github/actions/stage
        with:
          finished: ${{ inputs.finished }}
          from_artifact: ${{ !inputs.first }}
          save_artifact: false
          x86: false
          no_build: true

      - name: Copy PGO profile to workspace for caching
        id: copy-pgo
        run: Copy-Item -Path $env:PROJECT_LOCATION -Filter *.profdata -Destination $env:GITHUB_WORKSPACE -Recurse

      - name: Build Chromium LLVM
        id: build-llvm
        uses: ./.github/actions/stage
        with:
          finished: ${{ inputs.finished }}
          from_artifact: ${{ !inputs.first }}
          x86: false
          override_command: build_llvm.py

      - name: Upload compiled results
        if: steps.build-llvm.outputs.finished
        id: upload-artifact
        uses: actions/upload-artifact@v3
        with:
          name: chromium-llvm
          path: ${{ env.PROJECT_LOCATION }}\build\src\third_party\llvm-build
          retention-days: 5

      - name: Cache compiled LLVM
        if: steps.build-llvm.outputs.finished
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.PROJECT_LOCATION }}\build\src\third_party\llvm-build
          key: local-llvm-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}

      - name: Upload .patch rejects on build failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: patch-rejects
          path: |
            ${{ env.PROJECT_LOCATION }}\**\*.rej
            **\*.rej
          retention-days: 90

      # Don't save LLVM data if LLVM build may have failed
      - name: Fallback save downloads cache on build failure (1)
        if: failure() && (steps.build-llvm.outcome == 'success' || steps.build-llvm.outcome == 'skipped')
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.PROJECT_LOCATION }}\build\download_cache
            ${{ env.PROJECT_LOCATION }}\build\src\third_party
          key: ${{ env.CACHE_PREFIX }}-downloads-partial-including-extracted-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}

      - name: Fallback save downloads cache on build failure (2)
        if: failure() && (steps.build-llvm.outcome == 'failure' || steps.build-llvm.outcome == 'cancelled')
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.PROJECT_LOCATION }}\build\download_cache
          key: ${{ env.CACHE_PREFIX }}-downloads-partial-download-only-${{ hashFiles('**/downloads.ini', '**/chromium_version.txt') }}

      - name: Fallback save PGO cache on build failure
        if: failure() && steps.copy-pgo.outcome == 'success'
        uses: actions/cache/save@v3
        with:
          path: |
            **.profdata
            ${{ env.PROJECT_LOCATION }}\**.profdata
          key: ${{ env.CACHE_PREFIX }}-pgo-${{ hashFiles('**.profdata') }}

      - name: Fallback save pnpm cache on build failure
        if: failure() && steps.pnpm-install.outcome == 'success'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ env.CACHE_PREFIX }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ env.CACHE_PREFIX }}-pnpm-store-
    outputs:
      finished: ${{ steps.build-llvm.outputs.finished }}
